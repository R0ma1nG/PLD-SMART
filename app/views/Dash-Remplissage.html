<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">

    <title>Dashboard</title>

    <!-- Custom styles for this template -->

    <script src="js/dashboard.js"></script>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"rel="stylesheet" type="text/css">
    <link href="https://cdn.datatables.net/1.10.16/css/dataTables.jqueryui.min.css" rel="stylesheet" type="text/css">
    <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
    <link href="dashboard.css" rel="stylesheet" type="text/css">

    <!-- JS Scripts -->

    <script>
        var poubelles;
        var map;
        var markers = [];
        var infowindow;
        var icons = {
            0: {
                icon: '/ic_bin.png'
            },
            1: {
                icon: '/ic_bin_full.png'
            }
        };
        function initMap() {
            var lyon = { lat: 45.75, lng: 4.85 };
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: lyon
            });
            

            google.maps.event.addListener(map, 'zoom_changed', function () {
                var zoom = map.getZoom();
                // iterate over markers and call setVisible
                for (i = 0; i < markers.length; i++) {
                    markers[i].setVisible(zoom >= 15);
                }
            });
        };

        function getMarker(img) {
            var marker = markers.find(function (element) {
                return element.position == img.id;
            });
            map.setCenter(marker.position);
            map.setZoom(16);
            google.maps.event.trigger(marker, 'click');
            window.scrollTo(0, 0);
        };
    </script>

    <script>
        $(document).ready(function () {
            var table;
            if($.fn.dataTable.isDataTable("#recap")) {
                table = $("#recap").DataTable();
            } else {
                table = $("#recap").DataTable({
                    "orderClasses": false
                });
            }
            var url = "http://localhost:8080/api/poubelles";
            $.ajax
                ({
                    type: "GET",
                    contentType: "application/json",
                    //the url where you want to sent the userName and password to
                    url: `${url}`,
                    dataType: 'json',
                    error: function (err) {
                        alert('An error occured !');
                    }
                })
                .done(function (data) {
                    poubelles=data;
                    data.forEach(function (element) {
                        var pos = new google.maps.LatLng(element.lattitude, element.longitude);
                        var plein = element.remplissage ? "plein" : "disponible";
                        var contenu = [
                            '<img id="' + pos + '" src= "ic_zoom.png" height= 20 width= 20 onclick= "getMarker(this)" onmouseover= "" style= "cursor: pointer;" > </img>',
                            element.id_grandlyon,
                            element.adresse,
                            plein,
                            element.gestionnaire
                        ];
                        table.row.add(contenu).draw();
                        var marker = new google.maps.Marker({
                            position: pos,
                            map: map,
                            visible: true,
                            icon: icons[element.remplissage].icon
                        });
                        marker.addListener('click', function () {
                            if (infowindow) {
                                infowindow.close();
                            }
                            
                            var contentString = '<h4> Silo '+element.id_grandlyon+'</h4>' +
                                '<div>' +
                                'adresse: ' + element.adresse + '</br>' +
                                'Etat du remplissage: ' + plein +
                                '</div>';
                            marker.contentStr = contentString;
                            infowindow = new google.maps.InfoWindow({
                                content: contentString
                            });
                            infowindow.open(map, marker);
                        });
                        markers.push(marker);
                    });
                });
                feather.replace()
        });
    </script>
    <script>
        //filtrage remplissage
        $("#checkbox").click(function () {
            if ($("#checkbox").is(":checked")) {
                alert("check");
            }
        });
    </script>
    <!--<link href="./open-iconic/font/css/open-iconic-bootstrap.css" rel="stylesheet">-->

    
</head>

<body>

    <!-- En-tÃªte -->
    <nav class="navbar navbar-dark fixed-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-sm-3 col-md-11 mr-0" href="#">Recyc'Lyon - Interface Grand Lyon</a>
        <ul class="navbar-nav px-5">
            <li class="nav-item text-nowrap text-white">
                <span data-feather="log-out" onclick="logout();"></span>
            </li>
        </ul>
    </nav>


    <!-- Menu gauche -->
    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-2 d-none d-md-block bg-light sidebar">
                <div class="sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="./Dashboard">
                                        <span data-feather="trash-2"></span>Remplissage
                                        <span class="sr-only">(current)</span>
                                    </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="./Dashboard-Collecte">
                                        <span data-feather="trash"></span>
                                        Collecte
                                    </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="./Dashboard-Analyse">
                                        <span data-feather="activity"></span>
                                        Analyse
                                    </a>

                    </ul>


                </div>

            </nav>
        </div>
    </div>


    <!-- Barre de recherche -->

    <div class=" d-flex flex-row-reverse mt-5">
        <nav class="navbar col-md-10 d-flex justify-content-end navbar-dark bg-dark p-0">


            <div class="form-check form-check-inline">
                <label class="form-check-label text-light">
                            <input id="checkbox" type="checkbox" class="form-check-input " value=""> Remplissage critique
                        </label>
            </div>
            <select class="form-control w-25 mr-1" id="sel1">
                        <option>Grand Lyon</option>
                        <option>Lyon 1</option>
                        <option>Lyon 2</option>
                        <option>Lyon 3</option>
                        <option>Lyon 4</option>
                    </select>
            <input class="form-control form-control-dark w-25" type="text" placeholder="Recherche" aria-label="Recherche">
        </nav>

    </div>

    <!-- zone centrale -->
    <main role="main" class="col-md-9 ml-sm-auto col-lg-10">
        <h1>Remplissage des bennes</h1>
        <!-- Map -->
        <div id="map" overflow-y="auto"></div>
        <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCmnkXd0ojkMKWNFtGQxkaMZVNVuhXY75w&callback=initMap">

        </script>

        </br>
        </br>
        <h4>Tableau Recapitulatif</h4>
        <!--<div class="table-responsive"> -->
            <table id="recap" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th> </th>
                        <th># <span data-feather="chevron-down"></th>
                        <th>Adresse <span data-feather="chevron-down"></span></th>
                        <th>Remplissage <span data-feather="chevron-down"></th>
                        <th>Gestionnaire <span data-feather="chevron-down"></th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
</body>

</html>
